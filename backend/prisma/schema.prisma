generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                     BigInt             @id @default(autoincrement())
  username               String             @unique @db.VarChar(50)
  email                  String?            @unique @db.VarChar(255)
  passwordHash           String             @map("password_hash") @db.VarChar(255)
  status                 UserStatus         @default(Not_Verified)
  gender                 String?            @db.VarChar
  ageRange               String?            @map("age_range") @db.VarChar
  preferredPartnerGender String?            @map("preferred_partner_gender") @db.VarChar
  address                String?
  createdAt              DateTime           @default(now()) @map("created_at")
  updatedAt              DateTime           @updatedAt @map("updated_at")
  appointments           Appointment[]
  clinicStaff            ClinicStaff[]
  orders                 Order[]
  partnerReceipts        Partner[]          @relation("PartnerReceivedBy")
  partnerShares          Partner[]          @relation("PartnerSharedBy")
  practitioner           Practitioner?
  statusSharesTo         StatusShare[]      @relation("StatusShareRecipient")
  statusSharesSent       StatusShare[]      @relation("StatusShareSender")
  currentStatus          UserCurrentStatus?
  verifications          UserVerification[] @relation("UserVerifications")
  verifiedBy             UserVerification[] @relation("VerifiedByUser")

  @@map("users")
}

model Clinic {
  id               BigInt               @id @default(autoincrement())
  name             String               @db.VarChar
  address          String
  lat              Decimal?             @db.Decimal
  lng              Decimal?             @db.Decimal
  availableTime    String?              @map("available_time")
  createdAt        DateTime             @default(now()) @map("created_at")
  appointmentSlots AppointmentSlot[]
  staff            ClinicStaff[]
  practitioners    PractitionerClinic[]
  verifications    UserVerification[]

  @@index([name])
  @@map("clinics")
}

model ClinicStaff {
  id        BigInt          @id @default(autoincrement())
  clinicId  BigInt          @map("clinic_id")
  userId    BigInt          @map("user_id")
  role      ClinicStaffRole
  createdAt DateTime        @default(now()) @map("created_at")
  clinic    Clinic          @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([clinicId, userId])
  @@index([userId])
  @@map("clinic_staff")
}

model Practitioner {
  id               BigInt               @id @default(autoincrement())
  userId           BigInt               @unique @map("user_id")
  name             String               @db.VarChar
  specialization   String               @db.VarChar
  regNo            String?              @map("reg_no") @db.VarChar
  rating           Float?               @default(0)
  experience       Int?                 @default(0)
  imageUrl         String?              @map("image_url")
  createdAt        DateTime             @default(now()) @map("created_at")
  appointmentSlots AppointmentSlot[]
  clinics          PractitionerClinic[]
  user             User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([specialization])
  @@map("practitioners")
}

model PractitionerClinic {
  id             BigInt       @id @default(autoincrement())
  practitionerId BigInt       @map("practitioner_id")
  clinicId       BigInt       @map("clinic_id")
  clinic         Clinic       @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  practitioner   Practitioner @relation(fields: [practitionerId], references: [id], onDelete: Cascade)

  @@unique([practitionerId, clinicId])
  @@index([clinicId])
  @@map("practitioner_clinics")
}

model AppointmentSlot {
  id             BigInt              @id @default(autoincrement())
  practitionerId BigInt              @map("practitioner_id")
  clinicId       BigInt?             @map("clinic_id")
  mode           AppointmentSlotMode
  startsAt       DateTime            @map("starts_at")
  endsAt         DateTime            @map("ends_at")
  priceCents     Int                 @map("price_cents")
  isAvailable    Boolean             @default(true) @map("is_available")
  createdAt      DateTime            @default(now()) @map("created_at")
  clinic         Clinic?             @relation(fields: [clinicId], references: [id])
  practitioner   Practitioner        @relation(fields: [practitionerId], references: [id], onDelete: Cascade)
  appointments   Appointment[]

  @@index([practitionerId, startsAt])
  @@index([clinicId, startsAt])
  @@map("appointment_slots")
}

model Appointment {
  id        BigInt            @id @default(autoincrement())
  userId    BigInt            @map("user_id")
  slotId    BigInt            @map("slot_id")
  status    AppointmentStatus @default(booked)
  createdAt DateTime          @default(now()) @map("created_at")
  slot      AppointmentSlot   @relation(fields: [slotId], references: [id])
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments  Payment[]

  @@index([userId, createdAt])
  @@index([slotId])
  @@map("appointments")
}

model TestType {
  id            BigInt             @id @default(autoincrement())
  name          String             @unique @db.VarChar
  category      String?            @db.VarChar
  active        Boolean            @default(true)
  verifications UserVerification[]

  @@index([category])
  @@map("test_types")
}

model UserVerification {
  id               BigInt             @id @default(autoincrement())
  userId           BigInt             @map("user_id")
  testTypeId       BigInt             @map("test_type_id")
  clinicId         BigInt?            @map("clinic_id")
  verifiedByUserId BigInt?            @map("verified_by_user_id")
  status           VerificationStatus
  testedAt         DateTime?          @map("tested_at") @db.Date
  verifiedAt       DateTime?          @map("verified_at")
  createdAt        DateTime           @default(now()) @map("created_at")
  clinic           Clinic?            @relation(fields: [clinicId], references: [id])
  testType         TestType           @relation(fields: [testTypeId], references: [id])
  user             User               @relation("UserVerifications", fields: [userId], references: [id], onDelete: Cascade)
  verifiedByUser   User?              @relation("VerifiedByUser", fields: [verifiedByUserId], references: [id])

  @@index([userId, createdAt])
  @@index([userId, status])
  @@index([clinicId])
  @@map("user_verifications")
}

model UserCurrentStatus {
  userId         BigInt             @id @map("user_id")
  status         VerificationStatus @default(unverified)
  lastVerifiedAt DateTime?          @map("last_verified_at")
  updatedAt      DateTime           @updatedAt @map("updated_at")
  user           User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_current_status")
}

model Partner {
  id               BigInt        @id @default(autoincrement())
  sharedByUserId   BigInt        @map("shared_by_user_id")
  receivedByUserId BigInt        @map("received_by_user_id")
  status           PartnerStatus @default(pending)
  createdAt        DateTime      @default(now()) @map("created_at")
  acceptedAt       DateTime?     @map("accepted_at")
  userLow          BigInt?        @map("user_low")
  userHigh         BigInt?        @map("user_high")
  receivedByUser   User          @relation("PartnerReceivedBy", fields: [receivedByUserId], references: [id], onDelete: Cascade)
  sharedByUser     User          @relation("PartnerSharedBy", fields: [sharedByUserId], references: [id], onDelete: Cascade)

  @@unique([userLow, userHigh])
  @@index([sharedByUserId])
  @@index([receivedByUserId])
  @@map("partners")
}

model StatusShare {
  id                        BigInt    @id @default(autoincrement())
  senderUserId              BigInt    @map("sender_user_id")
  recipientUserId           BigInt?   @map("recipient_user_id")
  recipientUsernameSnapshot String?   @map("recipient_username_snapshot") @db.VarChar(50)
  tokenHash                 String    @unique @map("token_hash") @db.Char(64)
  createdAt                 DateTime  @default(now()) @map("created_at")
  expiresAt                 DateTime  @map("expires_at")
  viewedAt                  DateTime? @map("viewed_at")
  revokedAt                 DateTime? @map("revoked_at")
  maxViews                  Int       @default(1) @map("max_views")
  viewCount                 Int       @default(0) @map("view_count")
  recipient                 User?     @relation("StatusShareRecipient", fields: [recipientUserId], references: [id])
  sender                    User      @relation("StatusShareSender", fields: [senderUserId], references: [id], onDelete: Cascade)

  @@index([senderUserId, createdAt])
  @@index([recipientUserId, createdAt])
  @@map("status_shares")
}

model TestKit {
  id          BigInt      @id @default(autoincrement())
  name        String      @db.VarChar
  priceCents  Int         @map("price_cents")
  description String?
  active      Boolean     @default(true)
  orderItems  OrderItem[]

  @@map("test_kits")
}

model Order {
  id              BigInt      @id @default(autoincrement())
  userId          BigInt      @map("user_id")
  deliveryAddress String      @map("delivery_address")
  status          OrderStatus @default(created)
  createdAt       DateTime    @default(now()) @map("created_at")
  items           OrderItem[]
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments        Payment[]
  shipments       Shipment[]

  @@index([userId, createdAt])
  @@map("orders")
}

model OrderItem {
  id             BigInt  @id @default(autoincrement())
  orderId        BigInt  @map("order_id")
  testKitId      BigInt  @map("test_kit_id")
  qty            Int
  unitPriceCents Int     @map("unit_price_cents")
  order          Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  testKit        TestKit @relation(fields: [testKitId], references: [id])

  @@index([orderId])
  @@map("order_items")
}

model Payment {
  id               BigInt        @id @default(autoincrement())
  orderId          BigInt?       @map("order_id")
  appointmentId    BigInt?       @map("appointment_id")
  payhereReference String        @unique @map("payhere_reference") @db.VarChar
  amountCents      Int           @map("amount_cents")
  status           PaymentStatus
  createdAt        DateTime      @default(now()) @map("created_at")
  appointment      Appointment?  @relation(fields: [appointmentId], references: [id])
  order            Order?        @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([appointmentId])
  @@map("payments")
}

model Shipment {
  id             BigInt         @id @default(autoincrement())
  orderId        BigInt         @map("order_id")
  carrier        String?        @db.VarChar
  trackingNumber String?        @map("tracking_number") @db.VarChar
  status         ShipmentStatus @default(packed)
  shippedAt      DateTime?      @map("shipped_at")
  deliveredAt    DateTime?      @map("delivered_at")
  order          Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@map("shipments")
}

model Resource {
  id          String           @id @default(cuid())
  category    ResourceCategory
  title       String
  description String           @db.Text
  content     String           @db.Text
  imageUrl    String? // You can use Unsplash or local assets
  readTime    String           @default("5 min read")
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([category])
}

enum UserStatus {
  Verified
  Not_Verified
}

enum ClinicStaffRole {
  clinic_admin
  staff
}

enum AppointmentSlotMode {
  online
  physical
}

enum AppointmentStatus {
  booked
  cancelled
  completed
  no_show
}

enum VerificationStatus {
  verified
  unverified
}

enum PartnerStatus {
  pending
  accepted
  rejected
  blocked
}

enum OrderStatus {
  created
  paid
  shipped
  delivered
  cancelled
}

enum PaymentStatus {
  initiated
  paid
  failed
  refunded
}

enum ShipmentStatus {
  packed
  shipped
  delivered
}

enum ResourceCategory {
  SAFE_SEX
  CONSENT
  MENTAL_HEALTH
  SEXUAL_WELLBEING
}