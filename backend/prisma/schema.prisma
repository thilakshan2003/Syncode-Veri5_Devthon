generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model users {
  id                     BigInt               @id @default(autoincrement())
  username               String               @unique @db.VarChar(50)
  email                  String?              @unique @db.VarChar(255)
  passwordHash           String               @map("password_hash") @db.VarChar(255)
  status                 UserStatus           @default(Not_Verified)
  gender                 String?              @db.VarChar
  ageRange               String?              @map("age_range") @db.VarChar
  preferredPartnerGender String?              @map("preferred_partner_gender") @db.VarChar
  address                String?
  createdAt              DateTime             @default(now()) @map("created_at")
  updatedAt              DateTime             @updatedAt @map("updated_at")
  appointments           appointments[]
  clinicStaff            clinic_staff[]
  orders                 orders[]
  partnerReceipts        partners[]           @relation("PartnerReceivedBy")
  partnerShares          partners[]           @relation("PartnerSharedBy")
  practitioner           practitioners?
  statusSharesTo         status_shares[]      @relation("StatusShareRecipient")
  statusSharesSent       status_shares[]      @relation("StatusShareSender")
  currentStatus          user_current_status?
  verifications          user_verifications[] @relation("UserVerifications")
  verifiedBy             user_verifications[] @relation("VerifiedByUser")
  test_kit_instances     test_kit_instances[]

  @@map("users")
}

model clinics {
  id               BigInt                 @id @default(autoincrement())
  name             String                 @db.VarChar
  slug             String                 @unique @db.VarChar
  address          String
  lat              Decimal?               @db.Decimal
  lng              Decimal?               @db.Decimal
  availableTime    String?                @map("available_time")
  createdAt        DateTime               @default(now()) @map("created_at")
  appointmentSlots appointment_slots[]
  staff            clinic_staff[]
  practitioners    practitioner_clinics[]
  verifications    user_verifications[]

  @@index([name])
  @@map("clinics")
}

model clinic_staff {
  id        BigInt          @id @default(autoincrement())
  clinicId  BigInt          @map("clinic_id")
  userId    BigInt          @map("user_id")
  role      ClinicStaffRole
  createdAt DateTime        @default(now()) @map("created_at")
  clinic    clinics         @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  user      users           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([clinicId, userId])
  @@index([userId])
  @@map("clinic_staff")
}

model practitioners {
  id               BigInt                 @id @default(autoincrement())
  userId           BigInt                 @unique @map("user_id")
  name             String                 @db.VarChar
  specialization   String                 @db.VarChar
  regNo            String?                @map("reg_no") @db.VarChar
  rating           Float?                 @default(0)
  experience       Int?                   @default(0)
  imageUrl         String?                @map("image_url")
  createdAt        DateTime               @default(now()) @map("created_at")
  appointmentSlots appointment_slots[]
  clinics          practitioner_clinics[]
  user             users                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([specialization])
  @@map("practitioners")
}

model practitioner_clinics {
  id             BigInt        @id @default(autoincrement())
  practitionerId BigInt        @map("practitioner_id")
  clinicId       BigInt        @map("clinic_id")
  clinic         clinics       @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  practitioner   practitioners @relation(fields: [practitionerId], references: [id], onDelete: Cascade)

  @@unique([practitionerId, clinicId])
  @@index([clinicId])
  @@map("practitioner_clinics")
}

model appointment_slots {
  id             BigInt              @id @default(autoincrement())
  practitionerId BigInt              @map("practitioner_id")
  clinicId       BigInt?             @map("clinic_id")
  mode           AppointmentSlotMode
  startsAt       DateTime            @map("starts_at")
  endsAt         DateTime            @map("ends_at")
  priceCents     Int                 @map("price_cents")
  isAvailable    Boolean             @default(true) @map("is_available")
  createdAt      DateTime            @default(now()) @map("created_at")
  clinic         clinics?            @relation(fields: [clinicId], references: [id])
  practitioner   practitioners       @relation(fields: [practitionerId], references: [id], onDelete: Cascade)
  appointments   appointments[]

  @@index([practitionerId, startsAt])
  @@index([clinicId, startsAt])
  @@map("appointment_slots")
}

model appointments {
  id        BigInt            @id @default(autoincrement())
  userId    BigInt            @map("user_id")
  slotId    BigInt            @map("slot_id")
  status    AppointmentStatus @default(booked)
  createdAt DateTime          @default(now()) @map("created_at")
  slot      appointment_slots @relation(fields: [slotId], references: [id])
  user      users             @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments  payments[]

  @@index([userId, createdAt])
  @@index([slotId])
  @@map("appointments")
}

model user_verifications {
  id               BigInt             @id @default(autoincrement())
  userId           BigInt             @map("user_id")
  testKitId        BigInt             @map("test_kit_id")
  clinicId         BigInt?            @map("clinic_id")
  verifiedByUserId BigInt?            @map("verified_by_user_id")
  status           VerificationStatus
  testedAt         DateTime?          @map("tested_at") @db.Date
  verifiedAt       DateTime?          @map("verified_at")
  createdAt        DateTime           @default(now()) @map("created_at")
  clinic           clinics?           @relation(fields: [clinicId], references: [id])
  testKit          test_kits          @relation(fields: [testKitId], references: [id])
  user             users              @relation("UserVerifications", fields: [userId], references: [id], onDelete: Cascade)
  verifiedByUser   users?             @relation("VerifiedByUser", fields: [verifiedByUserId], references: [id])

  @@index([userId, createdAt])
  @@index([userId, status])
  @@index([clinicId])
  @@map("user_verifications")
}

model user_current_status {
  userId         BigInt             @id @map("user_id")
  status         VerificationStatus @default(unverified)
  lastVerifiedAt DateTime?          @map("last_verified_at")
  updatedAt      DateTime           @updatedAt @map("updated_at")
  user           users              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_current_status")
}

model partners {
  id               BigInt        @id @default(autoincrement())
  sharedByUserId   BigInt        @map("shared_by_user_id")
  receivedByUserId BigInt        @map("received_by_user_id")
  status           PartnerStatus @default(pending)
  createdAt        DateTime      @default(now()) @map("created_at")
  acceptedAt       DateTime?     @map("accepted_at")
  userLow          BigInt?       @default(dbgenerated()) @map("user_low")
  userHigh         BigInt?       @default(dbgenerated()) @map("user_high")
  receivedByUser   users         @relation("PartnerReceivedBy", fields: [receivedByUserId], references: [id], onDelete: Cascade)
  sharedByUser     users         @relation("PartnerSharedBy", fields: [sharedByUserId], references: [id], onDelete: Cascade)

  @@unique([userLow, userHigh])
  @@index([sharedByUserId])
  @@index([receivedByUserId])
  @@map("partners")
}

model status_shares {
  id                        BigInt    @id @default(autoincrement())
  senderUserId              BigInt    @map("sender_user_id")
  recipientUserId           BigInt?   @map("recipient_user_id")
  recipientUsernameSnapshot String?   @map("recipient_username_snapshot") @db.VarChar(50)
  tokenHash                 String    @unique @map("token_hash") @db.Char(64)
  createdAt                 DateTime  @default(now()) @map("created_at")
  expiresAt                 DateTime  @map("expires_at")
  viewedAt                  DateTime? @map("viewed_at")
  revokedAt                 DateTime? @map("revoked_at")
  maxViews                  Int       @default(1) @map("max_views")
  viewCount                 Int       @default(0) @map("view_count")
  recipient                 users?    @relation("StatusShareRecipient", fields: [recipientUserId], references: [id])
  sender                    users     @relation("StatusShareSender", fields: [senderUserId], references: [id], onDelete: Cascade)

  @@index([senderUserId, createdAt])
  @@index([recipientUserId, createdAt])
  @@map("status_shares")
}

model test_kits {
  id            BigInt               @id @default(autoincrement())
  name          String               @db.VarChar
  category      String?              @db.VarChar
  priceCents    Int                  @map("price_cents")
  description   String?
  active        Boolean              @default(true)
  orderItems    order_items[]
  instances     test_kit_instances[]
  verifications user_verifications[]

  @@index([category])
  @@map("test_kits")
}

model orders {
  id                 BigInt               @id @default(autoincrement())
  userId             BigInt               @map("user_id")
  deliveryAddress    String               @map("delivery_address")
  status             OrderStatus          @default(created)
  createdAt          DateTime             @default(now()) @map("created_at")
  items              order_items[]
  user               users                @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments           payments[]
  shipments          shipments[]
  test_kit_instances test_kit_instances[]

  @@index([userId, createdAt])
  @@map("orders")
}

model order_items {
  id             BigInt    @id @default(autoincrement())
  orderId        BigInt    @map("order_id")
  testKitId      BigInt    @map("test_kit_id")
  qty            Int
  unitPriceCents Int       @map("unit_price_cents")
  order          orders    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  testKit        test_kits @relation(fields: [testKitId], references: [id])

  @@index([orderId])
  @@map("order_items")
}

model payments {
  id               BigInt        @id @default(autoincrement())
  orderId          BigInt?       @map("order_id")
  appointmentId    BigInt?       @map("appointment_id")
  payhereReference String        @unique @map("payhere_reference") @db.VarChar
  amountCents      Int           @map("amount_cents")
  status           PaymentStatus
  createdAt        DateTime      @default(now()) @map("created_at")
  appointment      appointments? @relation(fields: [appointmentId], references: [id])
  order            orders?       @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([appointmentId])
  @@map("payments")
}

model shipments {
  id             BigInt         @id @default(autoincrement())
  orderId        BigInt         @map("order_id")
  carrier        String?        @db.VarChar
  trackingNumber String?        @map("tracking_number") @db.VarChar
  status         ShipmentStatus @default(packed)
  shippedAt      DateTime?      @map("shipped_at")
  deliveredAt    DateTime?      @map("delivered_at")
  order          orders         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@map("shipments")
}

model test_kit_instances {
  id            BigInt    @id @default(autoincrement())
  serial_number String    @unique @db.VarChar(100)
  test_kit_id   BigInt
  order_id      BigInt
  user_id       BigInt
  used_at       DateTime?
  verified_at   DateTime?
  created_at    DateTime  @default(now())

  test_kits test_kits @relation(fields: [test_kit_id], references: [id])
  orders    orders    @relation(fields: [order_id], references: [id], onDelete: Cascade)
  users     users     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([serial_number])
  @@map("test_kit_instances")
}

model resources {
  id          String           @id @default(cuid())
  category    ResourceCategory
  title       String
  description String           @db.Text
  content     String           @db.Text
  imageUrl    String? // You can use Unsplash or local assets
  readTime    String           @default("5 min read")
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([category])
  @@map("resources")
}

model audit_logs {
  id             BigInt   @id @default(autoincrement())
  verificationId BigInt   @map("verification_id")
  userId         BigInt   @map("user_id")
  oldStatus      String?  @map("old_status")
  newStatus      String   @map("new_status")
  timestamp      DateTime @default(now())

  @@map("audit_logs")
}

enum UserStatus {
  Verified
  Not_Verified
}

enum ClinicStaffRole {
  clinic_admin
  staff
}

enum AppointmentSlotMode {
  online
  physical
}

enum AppointmentStatus {
  booked
  cancelled
  completed
  no_show
}

enum VerificationStatus {
  verified
  unverified
  processing
}

enum PartnerStatus {
  pending
  accepted
  rejected
  blocked
}

enum OrderStatus {
  created
  paid
  shipped
  delivered
  cancelled
}

enum PaymentStatus {
  initiated
  paid
  failed
  refunded
}

enum ShipmentStatus {
  packed
  shipped
  delivered
}

enum ResourceCategory {
  SAFE_SEX
  CONSENT
  MENTAL_HEALTH
  SEXUAL_WELLBEING
}
