generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserStatus {
  active
  suspended
  deleted
}

enum ClinicStaffRole {
  clinic_admin
  staff
}

enum AppointmentSlotMode {
  online
  physical
}

enum AppointmentStatus {
  booked
  cancelled
  completed
  no_show
}

enum VerificationStatus {
  verified
  unverified
}

enum PartnerStatus {
  pending
  accepted
  rejected
  blocked
}

enum OrderStatus {
  created
  paid
  shipped
  delivered
  cancelled
}

enum PaymentStatus {
  initiated
  paid
  failed
  refunded
}

enum ShipmentStatus {
  packed
  shipped
  delivered
}

model User {
  id                BigInt             @id @default(autoincrement()) @db.BigInt
  username          String             @unique @db.VarChar(50)
  email             String?            @unique @db.VarChar(255)
  passwordHash      String             @map("password_hash") @db.VarChar(255)
  status            UserStatus         @default(active)
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  profile           UserProfile?
  clinicStaff       ClinicStaff[]
  practitioner      Practitioner?
  appointments      Appointment[]
  verifications     UserVerification[] @relation("UserVerifications")
  verifiedBy        UserVerification[] @relation("VerifiedByUser")
  currentStatus     UserCurrentStatus?
  partnerShares     Partner[]          @relation("PartnerSharedBy")
  partnerReceipts   Partner[]          @relation("PartnerReceivedBy")
  statusSharesSent  StatusShare[]      @relation("StatusShareSender")
  statusSharesTo    StatusShare[]      @relation("StatusShareRecipient")
  orders            Order[]

  @@map("users")
}

model UserProfile {
  userId                 BigInt  @id @map("user_id") @db.BigInt
  gender                 String? @db.VarChar
  ageRange               String? @map("age_range") @db.VarChar
  preferredPartnerGender String? @map("preferred_partner_gender") @db.VarChar
  address                String? @db.Text
  updatedAt              DateTime @updatedAt @map("updated_at")
  user                   User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profile")
}

model Clinic {
  id            BigInt                @id @default(autoincrement()) @db.BigInt
  name          String                @db.VarChar
  address       String                @db.Text
  lat           Decimal?              @db.Decimal
  lng           Decimal?              @db.Decimal
  availableTime String?               @map("available_time") @db.Text
  createdAt     DateTime              @default(now()) @map("created_at")
  staff         ClinicStaff[]
  practitioners PractitionerClinic[]
  appointmentSlots AppointmentSlot[]
  verifications UserVerification[]

  @@index([name])
  @@map("clinics")
}

model ClinicStaff {
  id        BigInt          @id @default(autoincrement()) @db.BigInt
  clinicId  BigInt          @map("clinic_id") @db.BigInt
  userId    BigInt          @map("user_id") @db.BigInt
  role      ClinicStaffRole
  createdAt DateTime        @default(now()) @map("created_at")
  clinic    Clinic          @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([clinicId, userId])
  @@index([userId])
  @@map("clinic_staff")
}

model Practitioner {
  id             BigInt                @id @default(autoincrement()) @db.BigInt
  userId         BigInt                @unique @map("user_id") @db.BigInt
  name           String                @db.VarChar
  specialization String                @db.VarChar
  regNo          String?               @map("reg_no") @db.VarChar
  createdAt      DateTime              @default(now()) @map("created_at")
  user           User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  clinics        PractitionerClinic[]
  appointmentSlots AppointmentSlot[]

  @@index([specialization])
  @@map("practitioners")
}

model PractitionerClinic {
  id              BigInt        @id @default(autoincrement()) @db.BigInt
  practitionerId  BigInt        @map("practitioner_id") @db.BigInt
  clinicId        BigInt        @map("clinic_id") @db.BigInt
  practitioner    Practitioner  @relation(fields: [practitionerId], references: [id], onDelete: Cascade)
  clinic          Clinic        @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  @@unique([practitionerId, clinicId])
  @@index([clinicId])
  @@map("practitioner_clinics")
}

model AppointmentSlot {
  id             BigInt               @id @default(autoincrement()) @db.BigInt
  practitionerId BigInt               @map("practitioner_id") @db.BigInt
  clinicId       BigInt?              @map("clinic_id") @db.BigInt
  mode           AppointmentSlotMode
  startsAt       DateTime             @map("starts_at")
  endsAt         DateTime             @map("ends_at")
  priceCents     Int                  @map("price_cents")
  isAvailable    Boolean              @default(true) @map("is_available")
  createdAt      DateTime             @default(now()) @map("created_at")
  practitioner   Practitioner         @relation(fields: [practitionerId], references: [id], onDelete: Cascade)
  clinic         Clinic?              @relation(fields: [clinicId], references: [id], onDelete: SetNull)
  appointments   Appointment[]

  @@index([practitionerId, startsAt])
  @@index([clinicId, startsAt])
  @@map("appointment_slots")
}

model Appointment {
  id        BigInt            @id @default(autoincrement()) @db.BigInt
  userId    BigInt            @map("user_id") @db.BigInt
  slotId    BigInt            @map("slot_id") @db.BigInt
  status    AppointmentStatus @default(booked)
  createdAt DateTime          @default(now()) @map("created_at")
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  slot      AppointmentSlot   @relation(fields: [slotId], references: [id], onDelete: Restrict)
  payments  Payment[]

  @@index([userId, createdAt])
  @@index([slotId])
  @@map("appointments")
}

model TestType {
  id        BigInt              @id @default(autoincrement()) @db.BigInt
  name      String              @unique @db.VarChar
  category  String?             @db.VarChar
  active    Boolean             @default(true)
  verifications UserVerification[]

  @@index([category])
  @@map("test_types")
}

model UserVerification {
  id               BigInt             @id @default(autoincrement()) @db.BigInt
  userId           BigInt             @map("user_id") @db.BigInt
  testTypeId       BigInt             @map("test_type_id") @db.BigInt
  clinicId         BigInt?            @map("clinic_id") @db.BigInt
  verifiedByUserId BigInt?            @map("verified_by_user_id") @db.BigInt
  status           VerificationStatus
  testedAt         DateTime?          @map("tested_at") @db.Date
  verifiedAt       DateTime?          @map("verified_at")
  createdAt        DateTime           @default(now()) @map("created_at")
  user             User               @relation("UserVerifications", fields: [userId], references: [id], onDelete: Cascade)
  testType         TestType           @relation(fields: [testTypeId], references: [id], onDelete: Restrict)
  clinic           Clinic?            @relation(fields: [clinicId], references: [id], onDelete: SetNull)
  verifiedByUser   User?              @relation("VerifiedByUser", fields: [verifiedByUserId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@index([userId, status])
  @@index([clinicId])
  @@map("user_verifications")
}

model UserCurrentStatus {
  userId         BigInt             @id @map("user_id") @db.BigInt
  status         VerificationStatus @default(unverified)
  lastVerifiedAt DateTime?          @map("last_verified_at")
  updatedAt      DateTime           @updatedAt @map("updated_at")
  user           User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_current_status")
}

model Partner {
  id               BigInt        @id @default(autoincrement()) @db.BigInt
  sharedByUserId   BigInt        @map("shared_by_user_id") @db.BigInt
  receivedByUserId BigInt        @map("received_by_user_id") @db.BigInt
  status           PartnerStatus @default(pending)
  createdAt        DateTime      @default(now()) @map("created_at")
  acceptedAt       DateTime?     @map("accepted_at")
  userLow          BigInt        @map("user_low") @default(dbgenerated("LEAST(\"shared_by_user_id\", \"received_by_user_id\")")) @db.BigInt
  userHigh         BigInt        @map("user_high") @default(dbgenerated("GREATEST(\"shared_by_user_id\", \"received_by_user_id\")")) @db.BigInt
  sharedByUser     User          @relation("PartnerSharedBy", fields: [sharedByUserId], references: [id], onDelete: Cascade)
  receivedByUser   User          @relation("PartnerReceivedBy", fields: [receivedByUserId], references: [id], onDelete: Cascade)

  @@index([sharedByUserId])
  @@index([receivedByUserId])
  @@unique([userLow, userHigh])
  @@map("partners")
}

model StatusShare {
  id                      BigInt    @id @default(autoincrement()) @db.BigInt
  senderUserId            BigInt    @map("sender_user_id") @db.BigInt
  recipientUserId         BigInt?   @map("recipient_user_id") @db.BigInt
  recipientUsernameSnapshot String? @map("recipient_username_snapshot") @db.VarChar(50)
  tokenHash               String    @unique @map("token_hash") @db.Char(64)
  createdAt               DateTime  @default(now()) @map("created_at")
  expiresAt               DateTime  @map("expires_at")
  viewedAt                DateTime? @map("viewed_at")
  revokedAt               DateTime? @map("revoked_at")
  maxViews                Int       @default(1) @map("max_views")
  viewCount               Int       @default(0) @map("view_count")
  sender                  User      @relation("StatusShareSender", fields: [senderUserId], references: [id], onDelete: Cascade)
  recipient               User?     @relation("StatusShareRecipient", fields: [recipientUserId], references: [id], onDelete: SetNull)

  @@index([senderUserId, createdAt])
  @@index([recipientUserId, createdAt])
  @@map("status_shares")
}

model TestKit {
  id          BigInt    @id @default(autoincrement()) @db.BigInt
  name        String    @db.VarChar
  priceCents  Int       @map("price_cents")
  description String?   @db.Text
  active      Boolean   @default(true)
  orderItems  OrderItem[]

  @@map("test_kits")
}

model Order {
  id              BigInt       @id @default(autoincrement()) @db.BigInt
  userId          BigInt       @map("user_id") @db.BigInt
  deliveryAddress String       @map("delivery_address") @db.Text
  status          OrderStatus  @default(created)
  createdAt       DateTime     @default(now()) @map("created_at")
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  items           OrderItem[]
  payments        Payment[]
  shipments       Shipment[]

  @@index([userId, createdAt])
  @@map("orders")
}

model OrderItem {
  id             BigInt   @id @default(autoincrement()) @db.BigInt
  orderId        BigInt   @map("order_id") @db.BigInt
  testKitId      BigInt   @map("test_kit_id") @db.BigInt
  qty            Int
  unitPriceCents Int      @map("unit_price_cents")
  order          Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  testKit        TestKit  @relation(fields: [testKitId], references: [id], onDelete: Restrict)

  @@index([orderId])
  @@map("order_items")
}

model Payment {
  id               BigInt        @id @default(autoincrement()) @db.BigInt
  orderId          BigInt?       @map("order_id") @db.BigInt
  appointmentId    BigInt?       @map("appointment_id") @db.BigInt
  payhereReference String        @unique @map("payhere_reference") @db.VarChar
  amountCents      Int           @map("amount_cents")
  status           PaymentStatus
  createdAt        DateTime      @default(now()) @map("created_at")
  order            Order?        @relation(fields: [orderId], references: [id], onDelete: SetNull)
  appointment      Appointment?  @relation(fields: [appointmentId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([appointmentId])
  @@map("payments")
}

model Shipment {
  id             BigInt        @id @default(autoincrement()) @db.BigInt
  orderId        BigInt        @map("order_id") @db.BigInt
  carrier        String?       @db.VarChar
  trackingNumber String?       @map("tracking_number") @db.VarChar
  status         ShipmentStatus @default(packed)
  shippedAt      DateTime?     @map("shipped_at")
  deliveredAt    DateTime?     @map("delivered_at")
  order          Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@map("shipments")
}
